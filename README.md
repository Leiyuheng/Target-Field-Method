# Target-Field-Method
Classical TFM method for MRI for the transverse dominant magnetic field under Halbach array

# Contourc 函数输出截断与电流流向问题

## 问题描述

在使用 MATLAB 的 `contourc` 函数提取电流线圈等值线时，存在以下两个主要问题：

1. **等值线截断**  
   - `contourc` 会针对不同层级高度分别提取闭合曲线。  
   - 在周期边界（如 0 到 2π）处，等值线若跨越边界会被截断并拆分为多段，导致原本一条闭合曲线分成多段保存。  
   - 例如，在 X 方向梯度线圈的负极（Negative）区域，本应每级提取两条闭合路径，因截断后每级多出一条路径，路径数量增加。

2. **电流流向判断**  
   - 截断后的等值线不再闭合，直接影响后续磁场计算和流向判定。  
   - 常见方法包括梯度叉乘、周期延拓或平面映射，但要么计算复杂、可扩展性差，要么依赖第三方工具，难以兼容不规则曲面。

## 解决方案

针对柱面区域（TFM 当前实现版本仅支持柱面结构），采用以下简化可靠的方法：

1. **边界互补段识别**  
   - 仅对 0 和 2π 边界上的等值线断段进行处理。  
   - 设定容差（tolerance），在等值线列表中寻找成对的互补路径并删除冗余段，最后按顺序连接，恢复闭合。

2. **一致性验证**  
   - 以 X 方向梯度线圈为示例，处理前 Negative 路径数为 42，Positive 为 28；处理后二者均为 28，验证了方法的准确性与高效性。

3. **电流流向人工校正**  
   - 由于自动判定方法泛化性差，最终在柱面条件下采用具有物理意义的人工设定条件，用于保证等值线电流流向的正确性。

4. **Apodization 系数调整**  
   - 对于系数 \(h\) 的选择，通过对比基于线圈计算的磁场与目标场，调整 \(h\) 值以优化线圈性能。

## 使用说明

1. 在生成等值线后，调用处理函数进行互补段检测与拼接。  
2. 视具体应用场景，酌情调整 `tolerance` 参数。  
3. 若后续需要支持更复杂几何，可基于此框架扩展边界处理逻辑。
![image](https://github.com/user-attachments/assets/465b34e1-97dd-4fa8-a403-2e5ccedcb93e)

*图 1. X 方向梯度线圈等值线未处理示意图，可以看到该组等值线由两组相同互补的等值线构成*

绿色为每条路径起点，黑色为终点，可以看到两组线圈路径互补

![image](https://github.com/user-attachments/assets/8cd2b110-aba8-48d2-848c-50ab45b0e644)

*图 2. X 方向梯度线圈等值线处理后示意图，可以看到该组等值线被合并为一组*

---

> 详细情况可见记录.docx

## 更新说明 2025.11.6
出于加工考虑,添加了输出文件夹Result,其中RAWdata是螺旋连接后未转为XYZ坐标的Phi-z坐标数据,用于PostProcess.m中转为柱面Rev1_cylinder或平面坐标Rev1_plane
而contourc_Plane_mm是等值线的平面坐标，通过子函数cylinder2plane.m输出的，等值线组的平面坐标
在solidworks中可以通过包覆进行操作，最终的线圈结构存储在3DStructure文件夹中
